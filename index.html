<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>舍鲜果电商订单汇总工具 </title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #28a745;
            --primary-dark: #218838;
            --secondary: #ff7b00;
            --accent: #ffc107;
            --light: #f8f9fa;
            --dark: #2d3e50;
            --success: #20c997;
            --warning: #fd7e14;
            --danger: #dc3545;
            --gray: #6c757d;
            --gray-light: #adb5bd;
            --border-radius: 12px;
            --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            min-height: 100vh;
            color: var(--dark);
            overflow-x: hidden;
        }

        #loginContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            z-index: 1000;
            transition: var(--transition);
        }

        #loginContainer.hidden {
            display: none;
        }

        .login-box {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 40px;
            width: 100%;
            max-width: 450px;
            text-align: center;
            position: relative;
        }

        .login-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
        }

        .login-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .login-title {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .login-subtitle {
            color: var(--gray);
            margin-bottom: 30px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 10px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 15px rgba(40, 167, 69, 0.3);
        }

        #loginError {
            color: var(--danger);
            margin-top: 15px;
            display: none;
        }

        .security-notice {
            margin-top: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            font-size: 0.9rem;
            color: var(--gray);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .hidden {
            display: none;
        }

        .app-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 20px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            position: relative;
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
        }

        .app-title {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .app-subtitle {
            color: var(--gray);
            font-size: 1.1rem;
        }

        .user-area {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 20px;
            transition: var(--transition);
        }

        .user-info:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
        }

        .user-name {
            font-weight: 600;
            color: var(--dark);
        }

        .logout-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s ease;
        }

        .user-info:hover .logout-btn {
            opacity: 1;
            transform: scale(1);
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .instructions {
            background: linear-gradient(135deg, #f0f9f0, #e8f5e9);
            border-left: 4px solid var(--primary);
            padding: 20px;
            border-radius: 0 10px 10px 0;
            margin-bottom: 30px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
            transition: var(--transition);
            height: fit-content;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: white;
            font-size: 1.5rem;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        textarea {
            width: 100%;
            min-height: 300px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            resize: vertical;
            font-size: 1rem;
            line-height: 1.6;
            transition: var(--transition);
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 15px rgba(40, 167, 69, 0.3);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.03);
            border-radius: 10px;
            overflow: hidden;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        th {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background-color: #f0f9f0;
        }

        .github-panel {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            margin-top: 30px;
        }

        .github-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .github-form {
                grid-template-columns: 1fr;
            }
        }

        .github-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .footer {
            text-align: center;
            padding: 30px;
            color: var(--gray);
            font-size: 0.9rem;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--dark);
            color: white;
            border-radius: 10px;
            box-shadow: var(--box-shadow);
            display: none;
            z-index: 1000;
        }

        .toast.show {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .user-management-panel {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            margin-top: 30px;
            border-left: 4px solid var(--primary);
        }

        .user-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .user-item-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-item-role {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        .user-item-actions {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .admin-only {
            display: none;
        }
    </style>
</head>
<body>
    <!-- 登录界面 -->
    <div id="loginContainer">
        <div class="login-box">
            <div class="login-icon">
                <i class="fas fa-lock"></i>
            </div>
            <h2 class="login-title">舍鲜果订单工具</h2>
            <p class="login-subtitle">多人协作版 - 请输入授权账号和密码</p>
            
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="username">账号</label>
                    <input type="text" id="username" class="form-input" placeholder="请输入账号" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="password">密码</label>
                    <input type="password" id="password" class="form-input" placeholder="请输入密码" required>
                </div>
                
                <button type="submit" class="login-btn">登录</button>
            </form>
            
            <div class="security-notice">
                <i class="fas fa-shield-alt"></i> 系统已启用安全保护，请联系管理员获取访问权限
            </div>
            
            <div id="loginError">
                <i class="fas fa-exclamation-circle"></i> 账号或密码错误，请重试
            </div>
        </div>
    </div>
    
    <!-- 主应用界面 -->
    <div id="appContainer" class="container hidden">
        <header class="app-header">
            <div class="user-area">
                <div class="user-info" id="userInfo">
                    <div class="user-avatar" id="userAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <span class="user-name" id="userName">用户</span>
                    <span class="user-item-role" id="userRole">普通用户</span>
                    <button class="logout-btn" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> 退出
                    </button>
                </div>
            </div>
            
            <h1 class="app-title">舍鲜果电商订单汇总工具</h1>
            <p class="app-subtitle">多人协作版 - 专为舍鲜果电商设计的智能订单处理工具</p>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-label">总订单数</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="processedToday">0</div>
                <div class="stat-label">今日已处理</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="timeSaved">0</div>
                <div class="stat-label">节省时间(分钟)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="successRate">100%</div>
                <div class="stat-label">识别成功率</div>
            </div>
        </div>
        <div class="main-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-edit"></i>
                    </div>
                    <h2 class="card-title">输入收件人信息</h2>
                </div>
                <textarea id="inputText" placeholder="请将收件人信息粘贴到这里，每个收件人信息用 # 号分隔。支持规格抓取（大果、中果、小果）。例如：

许洁[9991]
18412840520
海南省 海口市 美兰区 五指山路47号和谐家园商住楼A栋1单元2106[9991] 1盒大果
#
沙,18470715305-8352,江西省 赣州市 宁都县 梅江镇宝塔路,
#
通达18825593429北京朝阳区管庄地区塔营北街一号院二号楼~二单元楼302室、[2933]"></textarea>
                <button id="extractBtn" class="btn btn-primary">
                    <i class="fas fa-cogs"></i> 提取信息
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-table"></i>
                    </div>
                    <h2 class="card-title">提取结果</h2>
                </div>
                
                <div class="action-buttons">
                    <button id="saveBtn" class="btn btn-primary">
                        <i class="fas fa-save"></i> 保存数据
                    </button>
                    <button id="copyBtn" class="btn btn-primary">
                        <i class="fas fa-copy"></i> 复制表格数据
                    </button>
                    <button id="exportBtn" class="btn btn-primary">
                        <i class="fas fa-file-excel"></i> 导出Excel文件
                    </button>
                </div>
                
                <div id="tableContainer">
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>提取结果将显示在这里</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- GitHub数据存储面板 -->
        <div class="github-panel">
            <h3><i class="fab fa-github"></i> GitHub数据存储</h3>
            
            <div class="github-form">
                <div class="form-group">
                    <label class="form-label" for="githubToken">GitHub访问令牌</label>
                    <input type="password" id="githubToken" class="form-input" placeholder="输入GitHub Personal Access Token">
                    <small style="color: var(--gray);">需要repo权限的PAT</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="githubRepo">仓库名称</label>
                    <input type="text" id="githubRepo" class="form-input" placeholder="username/repo-name" value="your-username/fresh-fruit-orders">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="githubBranch">分支名称</label>
                    <input type="text" id="githubBranch" class="form-input" placeholder="分支名称" value="main">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="githubOwner">仓库所有者</label>
                    <input type="text" id="githubOwner" class="form-input" placeholder="GitHub用户名">
                </div>
            </div>
            
            <div class="github-actions">
                <button id="testGithubBtn" class="btn btn-primary">
                    <i class="fas fa-plug"></i> 测试连接
                </button>
                <button id="saveGithubConfigBtn" class="btn btn-primary">
                    <i class="fas fa-save"></i> 保存配置
                </button>
                <button id="syncToGithubBtn" class="btn btn-primary">
                    <i class="fas fa-cloud-upload-alt"></i> 同步到GitHub
                </button>
                <button id="loadFromGithubBtn" class="btn btn-primary">
                    <i class="fas fa-cloud-download-alt"></i> 从GitHub加载
                </button>
                <button id="loadAllFromGithubBtn" class="btn btn-primary admin-only">
                    <i class="fas fa-download"></i> 加载所有用户数据
                </button>
            </div>
        </div>

        <!-- 用户管理面板 - 仅管理员可见 -->
        <div class="user-management-panel admin-only" id="userManagementPanel">
            <h3><i class="fas fa-users-cog"></i> 用户管理</h3>
            <p style="color: var(--gray); margin-bottom: 20px;">管理员可以添加、删除用户，并同步用户数据到GitHub</p>
            
            <div class="github-form">
                <div class="form-group">
                    <label class="form-label" for="newUsername">用户名</label>
                    <input type="text" id="newUsername" class="form-input" placeholder="输入新用户名">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="newPassword">密码</label>
                    <input type="password" id="newPassword" class="form-input" placeholder="输入密码">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="userRoleSelect">用户角色</label>
                    <select id="userRoleSelect" class="form-input">
                        <option value="user">普通用户</option>
                        <option value="admin">管理员</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" style="visibility: hidden;">添加用户</label>
                    <button id="addUserBtn" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> 添加用户
                    </button>
                </div>
            </div>
            
            <div class="github-actions">
                <button id="syncUsersToGithubBtn" class="btn btn-primary">
                    <i class="fas fa-cloud-upload-alt"></i> 同步用户数据到GitHub
                </button>
                <button id="loadUsersFromGithubBtn" class="btn btn-primary">
                    <i class="fas fa-cloud-download-alt"></i> 从GitHub加载用户数据
                </button>
                <button id="refreshUsersBtn" class="btn btn-primary">
                    <i class="fas fa-sync"></i> 刷新用户列表
                </button>
            </div>
            
            <h4 style="margin-top: 30px; margin-bottom: 15px;">用户列表</h4>
            <div class="user-list" id="userList">
                <!-- 用户列表将动态生成 -->
            </div>
        </div>

        <div class="footer">
            <p>舍鲜果电商订单汇总工具 &copy; 2025 | 多人协作版 专为懒人电商出品</p>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // 系统配置
        const AUTHORIZED_USERS = [
            { username: "admin", password: "admin123", role: "admin" },
            { username: "user1", password: "password1", role: "user" }
        ];
        
        const STORAGE_KEY = 'fresh_fruit_order_data';
        const GITHUB_CONFIG_KEY = 'github_config';
        const USERS_CONFIG_KEY = 'authorized_users';
        let currentTableData = [];
        let processedCount = 0;
        let githubConfig = {};
        let currentUserRole = 'user';
        
        // 工具函数
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        function updateStats() {
            document.getElementById('totalOrders').textContent = processedCount;
            document.getElementById('processedToday').textContent = currentTableData.length;
            document.getElementById('timeSaved').textContent = Math.round(currentTableData.length * 2.5);
            document.getElementById('successRate').textContent = currentTableData.length > 0 ? '100%' : '0%';
        }
        
        function cleanAddress(address) {
            return address.replace(/\s*\d+\s*(盒|个|件|箱)\s*$/, '').trim();
        }
        
        // 信息提取功能
        function extractInfo(recipient) {
            let text = recipient.replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
            
            let extension = '';
            const extensionMatch = text.match(/\[(\d+)\]/);
            if (extensionMatch) {
                extension = `[${extensionMatch[1]}]`;
                text = text.replace(/\[\d+\]/, '');
            }
            
            let specification = '';
            const specMatch = text.match(/(大果|中果|小果)/);
            if (specMatch) {
                specification = specMatch[1];
            }
            
            let phone = '';
            const phoneMatch = text.match(/(\d{11})(-\d+)?/);
            if (phoneMatch) {
                phone = phoneMatch[1];
                
                if (phoneMatch[2] && !extension) {
                    extension = `[${phoneMatch[2].substring(1)}]`;
                }
                
                const phoneIndex = text.indexOf(phoneMatch[0]);
                let beforePhone = text.substring(0, phoneIndex).trim();
                let afterPhone = text.substring(phoneIndex + phoneMatch[0].length).trim();
                
                let name = beforePhone;
                name = name.replace(/[,，、]/g, '').trim();
                
                let address = afterPhone;
                address = address.replace(/[,，、]/g, ' ').trim();
                
                let quantity = '';
                const quantityMatch = text.match(/(\d+)\s*(盒|个|件|箱)/);
                if (quantityMatch) {
                    quantity = quantityMatch[1];
                    address = cleanAddress(address);
                }
                
                if (extension) {
                    name += extension;
                }
                
                return {
                    specification: specification,
                    quantity: quantity,
                    slash1: '',
                    slash2: '',
                    name: name,
                    phone: phone,
                    address: address,
                    remark: ''
                };
            }
            
            const lines = recipient.split('\n').map(line => line.trim()).filter(line => line);
            if (lines.length >= 3) {
                let nameLine = lines[0];
                let phoneLine = lines[1];
                let addressLine = lines[2];
                
                const nameMatch = nameLine.match(/^(.+?)(?:\[(\d+)\])?$/);
                if (nameMatch) {
                    nameLine = nameMatch[1];
                    if (nameMatch[2] && !extension) {
                        extension = `[${nameMatch[2]}]`;
                    }
                }
                
                const phoneMatch = phoneLine.match(/^(\d+)(?:-*\[(\d+)\])?$/);
                if (phoneMatch) {
                    phoneLine = phoneMatch[1];
                    if (phoneMatch[2] && !extension) {
                        extension = `[${phoneMatch[2]}]`;
                    }
                }
                
                const addressMatch = addressLine.match(/^(.+?)(?:\[(\d+)\])?$/);
                if (addressMatch) {
                    addressLine = addressMatch[1];
                    if (addressMatch[2] && !extension) {
                        extension = `[${addressMatch[2]}]`;
                    }
                }
                
                let quantity = '';
                if (lines.length > 3) {
                    const quantityMatch = lines[3].match(/(\d+)\s*(盒|个|件|箱)/);
                    if (quantityMatch) {
                        quantity = quantityMatch[1];
                    }
                } else {
                    const quantityMatch = addressLine.match(/(\d+)\s*(盒|个|件|箱)/);
                    if (quantityMatch) {
                        quantity = quantityMatch[1];
                        addressLine = cleanAddress(addressLine);
                    }
                }
                
                if (!specification) {
                    const specMatch = addressLine.match(/(大果|中果|小果)/);
                    if (specMatch) {
                        specification = specMatch[1];
                    addressLine = cleanAddress(addressLine);
                    }
                }
                
                const fullName = nameLine + extension;
                
                return {
                    specification: specification,
                    quantity: quantity,
                    slash1: '',
                    slash2: '',
                    name: fullName,
                    phone: phoneLine,
                    address: addressLine,
                    remark: ''
                };
            }
            
            return {
                specification: '',
                quantity: '',
                slash1: '',
                slash2: '',
                name: text,
                phone: '',
                address: '',
                remark: '解析失败'
            };
        }
        
        function generateTable(data) {
            const tableContainer = document.getElementById('tableContainer');
            
            if (data.length === 0) {
                tableContainer.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>未提取到有效信息</p></div>';
                return;
            }
            
            let tableHTML = '<table><thead><tr>';
            tableHTML += '<th>规格</th><th>数量</th><th>/</th><th>/</th><th>姓名</th><th>电话</th><th>地址</th><th>备注</th>';
            tableHTML += '</tr></thead><tbody>';
            
            data.forEach(item => {
                tableHTML += `<tr>
                    <td>${item.specification}</td>
                    <td>${item.quantity}</td>
                    <td>${item.slash1}</td>
                    <td>${item.slash2}</td>
                    <td>${item.name}</td>
                    <td>${item.phone}</td>
                    <td>${item.address}</td>
                    <td>${item.remark}</td>
                </tr>`;
            });
            
            tableHTML += '</tbody></table>';
            tableContainer.innerHTML = tableHTML;
        }
        
        function exportToExcel(data, filename) {
            const wb = XLSX.utils.book_new();
            const wsData = [['规格', '数量', '/', '/', '姓名', '电话', '地址', '备注']];
            
            data.forEach(item => {
                wsData.push([
                    item.specification,
                    item.quantity,
                    item.slash1,
                    item.slash2,
                    item.name,
                    item.phone,
                    item.address,
                    item.remark
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, '订单信息');
            XLSX.writeFile(wb, filename + '.xlsx');
        }
        
        // GitHub集成功能
        function loadGithubConfig() {
            const configStr = localStorage.getItem(GITHUB_CONFIG_KEY);
            if (configStr) {
                githubConfig = JSON.parse(configStr);
                document.getElementById('githubToken').value = githubConfig.token || '';
                document.getElementById('githubRepo').value = githubConfig.repo || 'your-username/fresh-fruit-orders';
                document.getElementById('githubBranch').value = githubConfig.branch || 'main';
                document.getElementById('githubOwner').value = githubConfig.owner || '';
            }
        }
        
        function saveGithubConfig() {
            githubConfig = {
                token: document.getElementById('githubToken').value,
                repo: document.getElementById('githubRepo').value,
                branch: document.getElementById('githubBranch').value,
                owner: document.getElementById('githubOwner').value
            };
            
            localStorage.setItem(GITHUB_CONFIG_KEY, JSON.stringify(githubConfig));
            showToast('GitHub配置已保存');
        }
        
        async function githubApiRequest(url, method = 'GET', body = null) {
            const headers = {
                'Authorization': `token ${githubConfig.token}`,
                'Accept': 'application/vnd.github.v3+json'
            };
            
            const options = {
                method,
                headers
            };
            
            if (body) {
                options.body = JSON.stringify(body);
                headers['Content-Type'] = 'application/json';
            }
            
            try {
                const response = await fetch(url, options);
                if (response.ok) {
                    return await response.json();
                } else {
                    throw new Error(`GitHub API错误: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('GitHub API请求失败:', error);
                throw error;
            }
        }
        
        async function testGithubConnection() {
            if (!githubConfig.token) {
                showToast('请输入GitHub访问令牌', 'error');
                return;
            }
            
            try {
                const userData = await githubApiRequest('https://api.github.com/user');
                showToast(`连接成功！欢迎，${userData.login}`);
                return true;
            } catch (error) {
                showToast('GitHub连接失败: ' + error.message, 'error');
                return false;
            }
        }
        
        async function syncToGithub() {
            if (currentTableData.length === 0) {
                showToast('没有数据可同步', 'error');
                return;
            }
            
            if (!githubConfig.token || !githubConfig.repo || !githubConfig.owner) {
                showToast('请先配置GitHub信息', 'error');
                return;
            }
            
            try {
                const currentUser = localStorage.getItem('loggedInUser');
                const timestamp = new Date().getTime();
                const filename = `orders/${currentUser}_${timestamp}.json`;
                
                const data = {
                    user: currentUser,
                    timestamp: timestamp,
                    data: currentTableData
                };
                
                const fileUrl = `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${filename}`;
                let sha = null;
                
                try {
                    const existingFile = await githubApiRequest(`${fileUrl}?ref=${githubConfig.branch}`);
                    sha = existingFile.sha;
                } catch (e) {
                    // 文件不存在，这是新文件
                }
                
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                
                const response = await githubApiRequest(fileUrl, 'PUT', {
                    message: `同步订单数据 - ${currentUser} - ${new Date(timestamp).toLocaleString()}`,
                    content: content,
                    branch: githubConfig.branch,
                    sha: sha
                });
                
                showToast('数据已成功同步到GitHub');
                return response;
            } catch (error) {
                showToast('同步失败: ' + error.message, 'error');
                throw error;
            }
        }
        
        async function loadFromGithub() {
            if (!githubConfig.token || !githubConfig.repo || !githubConfig.owner) {
                showToast('请先配置GitHub信息', 'error');
                return;
            }
            
            try {
                const currentUser = localStorage.getItem('loggedInUser');
                const isAdmin = currentUserRole === 'admin';
                
                let files = [];
                
                if (isAdmin) {
                    // 管理员可以获取所有文件
                    const response = await githubApiRequest(
                        `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/orders?ref=${githubConfig.branch}`
                    );
                    files = response;
                } else {
                    // 普通用户只能获取自己的文件
                    const response = await githubApiRequest(
                        `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/orders?ref=${githubConfig.branch}`
                    );
                    files = response.filter(file => file.name.includes(currentUser));
                }
                
                if (files.length === 0) {
                    showToast('GitHub上没有找到订单数据', 'error');
                    return;
                }
                
                // 获取最新文件
                const latestFile = files.sort((a, b) => 
                    new Date(b.name) - new Date(a.name)
                )[0];
                
                const fileContent = await githubApiRequest(latestFile.download_url);
                currentTableData = fileContent.data;
                
                generateTable(currentTableData);
                showToast(`从GitHub加载了 ${currentTableData.length} 条订单数据`);
            } catch (error) {
                showToast('从GitHub加载数据失败: ' + error.message, 'error');
            }
        }
        
        // 用户管理功能
        function loadUsers() {
            const usersStr = localStorage.getItem(USERS_CONFIG_KEY);
            if (usersStr) {
                return JSON.parse(usersStr);
            } else {
                // 首次使用，保存初始用户
                localStorage.setItem(USERS_CONFIG_KEY, JSON.stringify(AUTHORIZED_USERS));
                return AUTHORIZED_USERS;
            }
        }
        
        function saveUsers(users) {
            localStorage.setItem(USERS_CONFIG_KEY, JSON.stringify(users));
        }
        
        function addUser(username, password, role) {
            const users = loadUsers();
            
            // 检查用户是否已存在
            if (users.some(user => user.username === username)) {
                return { success: false, message: '用户名已存在' };
            }
            
            // 添加新用户
            users.push({ username, password, role });
            saveUsers(users);
            
            return { success: true, message: '用户添加成功' };
        }
        
        function deleteUser(username) {
            const users = loadUsers();
            
            // 防止删除当前登录用户
            const currentUser = localStorage.getItem('loggedInUser');
            if (username === currentUser) {
                return { success: false, message: '不能删除当前登录用户' };
            }
            
            // 防止删除最后一个管理员
            const adminUsers = users.filter(user => user.role === 'admin');
            if (adminUsers.length === 1 && adminUsers[0].username === username) {
                return { success: false, message: '必须至少保留一个管理员账户' };
            }
            
            const filteredUsers = users.filter(user => user.username !== username);
            saveUsers(filteredUsers);
            
            return { success: true, message: '用户删除成功' };
        }
        
        function renderUserList() {
            const userList = document.getElementById('userList');
            const users = loadUsers();
            
            if (users.length === 0) {
                userList.innerHTML = '<div class="user-item" style="justify-content: center; color: var(--gray);">暂无用户</div>';
                return;
            }
            
            let userListHTML = '';
            users.forEach(user => {
                userListHTML += `
                    <div class="user-item">
                        <div class="user-item-info">
                            <div class="user-avatar" style="width: 24px; height: 24px; font-size: 0.7rem;">
                                ${user.username.charAt(0).toUpperCase()}
                            </div>
                            <span>${user.username}</span>
                            <span class="user-item-role" style="background: ${user.role === 'admin' ? 'var(--primary)' : 'var(--gray)'}">
                                ${user.role === 'admin' ? '管理员' : '普通用户'}
                            </span>
                        </div>
                        <div class="user-item-actions">
                            <button class="btn btn-small btn-danger delete-user-btn" data-username="${user.username}">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    </div>
                `;
            });
            
            userList.innerHTML = userListHTML;
            
            // 添加删除按钮事件监听
            document.querySelectorAll('.delete-user-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    const result = deleteUser(username);
                    
                    if (result.success) {
                        showToast(result.message);
                        renderUserList();
                    } else {
                        showToast(result.message, 'error');
                    }
                });
            });
        }
        
        function updateUserInterface() {
            const isAdmin = currentUserRole === 'admin';
            
            // 显示/隐藏管理员功能
            const adminElements = document.querySelectorAll('.admin-only');
            adminElements.forEach(el => {
                el.style.display = isAdmin ? 'block' : 'none';
            });
            
            if (isAdmin) {
                renderUserList();
            }
        }
        
        // 事件监听器
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            const users = loadUsers();
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                localStorage.setItem('loggedInUser', username);
                localStorage.setItem('userRole', user.role);
                currentUserRole = user.role;
                errorDiv.style.display = 'none';
                
                document.getElementById('loginContainer').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                
                document.getElementById('userName').textContent = username;
                document.getElementById('userAvatar').innerHTML = username.charAt(0).toUpperCase();
                document.getElementById('userRole').textContent = user.role === 'admin' ? '管理员' : '普通用户';
                
                updateUserInterface();
                loadGithubConfig();
                
                showToast(`欢迎回来，${username}！`);
            } else {
                errorDiv.style.display = 'block';
                document.getElementById('password').value = '';
            }
        });
        
        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.removeItem('loggedInUser');
            localStorage.removeItem('userRole');
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('appContainer').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').style.display = 'none';
        });
        
        document.getElementById('extractBtn').addEventListener('click', function() {
            const inputText = document.getElementById('inputText').value.trim();
            if (!inputText) {
                showToast('请输入收件人信息', 'error');
                return;
            }
            
            const recipients = inputText.split('#').map(r => r.trim()).filter(r => r);
            currentTableData = [];
            
            recipients.forEach(recipient => {
                const extractedInfo = extractInfo(recipient);
                currentTableData.push(extractedInfo);
            });
            
            generateTable(currentTableData);
            processedCount += currentTableData.length;
            updateStats();
            
            if (currentTableData.length > 0) {
                showToast(`成功提取 ${currentTableData.length} 条订单信息`);
            } else {
                showToast('未提取到有效信息，请检查输入格式', 'error');
            }
        });
        
        document.getElementById('saveBtn').addEventListener('click', function() {
            if (currentTableData.length === 0) {
                showToast('没有数据可保存', 'error');
                return;
            }
            
            const allData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const timestamp = new Date().getTime();
            const expiryTime = timestamp + (3 * 24 * 60 * 60 * 1000);
            const currentUser = localStorage.getItem('loggedInUser');
            
            const newData = {
                id: timestamp,
                username: currentUser,
                data: currentTableData,
                timestamp: timestamp,
                expiry: expiryTime
            };
            
            allData.push(newData);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
            
            showToast(`数据已保存（${currentTableData.length} 条）`);
        });
        
        document.getElementById('copyBtn').addEventListener('click', function() {
            if (currentTableData.length === 0) {
                showToast('没有表格数据可复制', 'error');
                return;
            }
            
            let csvContent = '规格,数量,/,/,姓名,电话,地址,备注\n';
            
            currentTableData.forEach(item => {
                csvContent += `${item.specification},${item.quantity},${item.slash1},${item.slash2},${item.name},${item.phone},${item.address},${item.remark}\n`;
            });
            
            navigator.clipboard.writeText(csvContent).then(() => {
                showToast('表格数据已复制到剪贴板');
            }).catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = csvContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('表格数据已复制到剪贴板');
            });
        });
        
        document.getElementById('exportBtn').addEventListener('click', function() {
            if (currentTableData.length === 0) {
                showToast('没有表格数据可导出', 'error');
                return;
            }
            
            const date = new Date();
            const filename = `舍鲜果订单信息_${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
            
            exportToExcel(currentTableData, filename);
            showToast('Excel文件已生成并开始下载');
        });
        
        // GitHub相关事件监听器
        document.getElementById('testGithubBtn').addEventListener('click', testGithubConnection);
        document.getElementById('saveGithubConfigBtn').addEventListener('click', saveGithubConfig);
        document.getElementById('syncToGithubBtn').addEventListener('click', syncToGithub);
        document.getElementById('loadFromGithubBtn').addEventListener('click', loadFromGithub);
        
        // 用户管理事件监听器
        document.getElementById('addUserBtn').addEventListener('click', function() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value.trim();
            const role = document.getElementById('userRoleSelect').value;
            
            if (!username || !password) {
                showToast('请输入用户名和密码', 'error');
                return;
            }
            
            const result = addUser(username, password, role);
            if (result.success) {
                showToast(result.message);
                document.getElementById('newUsername').value = '';
                document.getElementById('newPassword').value = '';
                renderUserList();
            } else {
                showToast(result.message, 'error');
            }
        });
        
        document.getElementById('syncUsersToGithubBtn').addEventListener('click', function() {
            const users = loadUsers();
            const data = {
                users: users,
                timestamp: new Date().getTime(),
                updatedBy: localStorage.getItem('loggedInUser')
            };
            
            localStorage.setItem(USERS_CONFIG_KEY, JSON.stringify(users));
            showToast('用户数据已保存到本地');
        });
        
        document.getElementById('loadUsersFromGithubBtn').addEventListener('click', function() {
            // 这里可以添加从GitHub加载用户数据的逻辑
            showToast('从GitHub加载用户数据功能待实现');
        });
        
        document.getElementById('refreshUsersBtn').addEventListener('click', function() {
            renderUserList();
            showToast('用户列表已刷新');
        });
        
        // 页面加载时检查登录状态
        window.addEventListener('load', function() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            const userRole = localStorage.getItem('userRole');
            
            if (loggedInUser) {
                currentUserRole = userRole || 'user';
                document.getElementById('loginContainer').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                document.getElementById('userName').textContent = loggedInUser;
                document.getElementById('userAvatar').innerHTML = loggedInUser.charAt(0).toUpperCase();
                document.getElementById('userRole').textContent = currentUserRole === 'admin' ? '管理员' : '普通用户';
                updateUserInterface();
                loadGithubConfig();
            }
            
            updateStats();
        });
    </script>
</body>
</html>



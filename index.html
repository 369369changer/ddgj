<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>舍鲜果电商订单汇总工具</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <style>
        :root {
            --primary: #28a745; --primary-dark: #218838; --secondary: #ff7b00; --accent: #ffc107;
            --light: #f8f9fa; --dark: #2d3e50; --success: #20c997; --warning: #fd7e14; --danger: #dc3545;
            --gray: #6c757d; --gray-light: #adb5bd; --border-radius: 12px; --box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            --transition: all 0.3s ease;
        }
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
        body{background:linear-gradient(135deg,#e8f5e9 0%,#c8e6c9 100%);min-height:100vh;color:var(--dark);overflow-x:hidden;}
        
        /* 移动端优化 */
        html { font-size: 16px; }
        @media (max-width: 768px) {
            html { font-size: 14px; }
        }
        @media (max-width: 480px) {
            html { font-size: 13px; }
        }
        
        /* 登录容器 */
        #loginContainer{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;justify-content:center;align-items:center;background:linear-gradient(135deg,#e8f5e9 0%,#c8e6c9 100%);z-index:1000}
        #loginContainer.hidden{display:none}
        .login-box{background:#fff;border-radius:var(--border-radius);box-shadow:var(--box-shadow);padding:40px;max-width:450px;width:100%;text-align:center}
        @media (max-width: 768px) {
            .login-box { padding: 30px 20px; margin: 0 15px; }
        }
        .login-icon{font-size:3rem;color:var(--primary);margin-bottom:20px}
        .login-title{font-size:1.8rem;margin-bottom:10px;color:var(--dark)}
        .login-subtitle{color:var(--gray);margin-bottom:30px}
        .login-form{display:flex;flex-direction:column;gap:20px}
        .form-group{text-align:left}
        .form-label{display:block;margin-bottom:8px;font-weight:600;color:var(--dark)}
        .form-input{width:100%;padding:12px 15px;border:1px solid #e0e0e0;border-radius:8px;font-size:1rem}
        .login-btn{width:100%;padding:14px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;border:none;border-radius:8px;font-size:1rem;cursor:pointer}
        .security-notice{margin-top:25px;padding:15px;background:#f8f9fa;border-radius:8px;border-left:4px solid var(--primary);font-size:0.9rem;color:var(--gray)}
        
        /* 主容器 */
        .container{max-width:1400px;margin:0 auto;padding:20px}
        @media (max-width: 768px) {
            .container { padding: 10px; }
        }
        .hidden{display:none}
        
        /* 应用头部 */
        .app-header{background:#fff;border-radius:var(--border-radius);padding:30px;text-align:center;box-shadow:var(--box-shadow);margin-bottom:20px;position:relative}
        @media (max-width: 768px) {
            .app-header { padding: 20px 15px; }
        }
        
        /* 用户中心布局修复 */
        .user-area{position:absolute;top:18px;right:20px;display:flex;align-items:center;gap:10px;background:transparent}
        @media (max-width: 768px) {
            .user-area { 
                position: static; 
                justify-content: center; 
                margin-top: 15px; 
                flex-wrap: wrap; 
            }
            .user-info { flex-wrap: wrap; justify-content: center; }
        }
        .user-info{display:flex;align-items:center;gap:10px;padding:6px 10px;border-radius:20px;transition:var(--transition);background:rgba(0,0,0,0.02)}
        .user-info:hover{background:rgba(0,0,0,0.04)}
        .user-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--secondary));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
        .user-name{font-weight:600;color:var(--dark);margin-left:4px}
        .user-role-badge{margin-left:6px;padding:4px 8px;border-radius:12px;background:var(--gray);color:#fff;font-size:0.8rem}
        .logout-btn{background:var(--danger);color:#fff;border:none;border-radius:6px;padding:6px 10px;font-size:0.8rem;cursor:pointer;display:inline-flex;align-items:center;gap:6px}
        
        /* 统计网格 */
        .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:30px}
        @media (max-width: 768px){
            .stats-grid{grid-template-columns:repeat(2,1fr); gap: 15px; }
        }
        @media (max-width: 480px){
            .stats-grid{grid-template-columns:1fr; gap: 10px; }
        }
        
        /* 卡片样式 */
        .card{background:#fff;border-radius:var(--border-radius);padding:30px;box-shadow:var(--box-shadow);margin-bottom:20px}
        @media (max-width: 768px) {
            .card { padding: 20px 15px; }
        }
        
        /* 主内容区域 */
        .main-content{display:grid;grid-template-columns:1fr 1fr;gap:30px}
        @media (max-width: 1024px) {
            .main-content { grid-template-columns: 1fr; gap: 20px; }
        }
        
        textarea{width:100%;min-height:300px;padding:20px;border:1px solid #e0e0e0;border-radius:10px;resize:vertical;font-size:1rem}
        @media (max-width: 768px) {
            textarea { min-height: 200px; padding: 15px; }
        }
        
        /* 按钮样式 */
        .btn{padding:12px 18px;border:none;border-radius:8px;cursor:pointer;font-size:1rem}
        @media (max-width: 768px) {
            .btn { padding: 10px 15px; font-size: 0.9rem; }
        }
        .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff}
        .action-buttons{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
        @media (max-width: 768px) {
            .action-buttons { flex-direction: column; }
            .action-buttons .btn { width: 100%; }
        }
        
        /* 表格样式 */
        table{width:100%;border-collapse:collapse;margin-top:20px}
        @media (max-width: 768px) {
            .table-container { overflow-x: auto; }
            table { min-width: 600px; }
        }
        th,td{padding:12px;text-align:left;border-bottom:1px solid #f0f0f0}
        th{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff}
        tr:hover{background:#f0f9f0}
        .empty-state{text-align:center;padding:40px;color:var(--gray)}
        
        /* GitHub面板 */
        .github-panel,.user-management-panel{background:#fff;border-radius:var(--border-radius);padding:20px;box-shadow:var(--box-shadow);margin-top:20px}
        @media (max-width: 768px) {
            .github-panel, .user-management-panel { padding: 15px; }
        }
        
        /* GitHub面板内部布局 */
        .github-panel > div:first-of-type { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 12px; }
        @media (max-width: 1024px) {
            .github-panel > div:first-of-type { grid-template-columns: 1fr; }
        }
        
        /* 用户列表 */
        .user-list{max-height:300px;overflow-y:auto;border:1px solid #e0e0e0;border-radius:8px;margin-top:10px}
        .user-item{display:flex;justify-content:space-between;align-items:center;padding:12px 15px;border-bottom:1px solid #f0f0f0}
        .user-item:last-child{border-bottom:none}
        .user-item-role{background:var(--primary);color:#fff;padding:2px 8px;border-radius:10px;font-size:0.7rem}
        .btn-small{padding:6px 10px;font-size:0.85rem;border-radius:6px}
        .btn-danger{background:var(--danger);color:#fff}
        
        /* 表单行布局 */
        .form-row{display:flex;gap:12px;align-items:center}
        @media (max-width: 768px) {
            .form-row { flex-direction: column; align-items: stretch; }
        }
        
        /* 弹窗和提示 */
        .toast{position:fixed;bottom:20px;right:20px;padding:15px 25px;background:var(--dark);color:#fff;border-radius:10px;display:none;z-index:1000;max-width: 90%;}
        .toast.show{display:block}
        #savedDataModal{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:760px;max-height:70vh;overflow:auto;background:#fff;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.2);padding:18px;z-index:2000}
        @media (max-width: 768px) {
            #savedDataModal { width: 90%; max-width: 90%; padding: 15px; }
        }
        
        .admin-only{display:none}
        select.form-input{padding:8px;border-radius:6px;border:1px solid #e0e0f0;background:#fff}
        .small-note{color:var(--gray);font-size:0.85rem;margin-top:6px}
        
        /* 按钮组 */
        .github-panel > div:last-of-type, .user-management-panel > div:last-of-type { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
        @media (max-width: 768px) {
            .github-panel > div:last-of-type, .user-management-panel > div:last-of-type { flex-direction: column; }
            .github-panel > div:last-of-type .btn, .user-management-panel > div:last-of-type .btn { width: 100%; }
        }
        
        /* 用户管理面板 */
        .user-management-panel > div:nth-of-type(2) { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px; }
        @media (max-width: 768px) {
            .user-management-panel > div:nth-of-type(2) { grid-template-columns: 1fr; }
        }
        
        /* 移动端底部安全区域 */
        .footer { margin-top: 18px; text-align: center; color: var(--gray); padding-bottom: env(safe-area-inset-bottom, 20px); }
    </style>
</head>
<body>
    <!-- 登录页面保持不变 -->
    <div id="loginContainer">
        <div class="login-box">
            <div class="login-icon"><i class="fas fa-lock"></i></div>
            <h2 class="login-title">舍鲜果订单工具</h2>
            <p class="login-subtitle">多人协作版 - 请输入授权账号和密码</p>
            <form class="login-form" id="loginForm">
                <div class="form-group"><label class="form-label" for="username">账号</label><input id="username" class="form-input" required></div>
                <div class="form-group"><label class="form-label" for="password">密码</label><input id="password" type="password" class="form-input" required></div>
                <button type="submit" class="login-btn">登录</button>
            </form>
            <div class="security-notice"><i class="fas fa-shield-alt"></i> 系统已启用安全保护，请联系管理员获取访问权限</div>
            <div id="loginError" style="color:var(--danger);margin-top:12px;display:none;"><i class="fas fa-exclamation-circle"></i> 账号或密码错误，请重试</div>
        </div>
    </div>

    <!-- 主应用容器 -->
    <div id="appContainer" class="container hidden">
        <header class="app-header">
            <div class="user-area">
                <div class="user-info" id="userInfo">
                    <div class="user-avatar" id="userAvatar"><i class="fas fa-user"></i></div>
                    <div class="user-name" id="userName">用户</div>
                    <div class="user-role-badge" id="userRole">普通用户</div>
                    <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> 退出</button>
                </div>
            </div>
            <h1 class="app-title">舍鲜果电商订单汇总工具</h1>
            <p class="app-subtitle" style="color:var(--gray)">多人协作版 - 专为舍鲜果电商设计的智能订单处理工具</p>
        </header>

        <div class="stats-grid">
            <div class="card"><div style="font-size:1.6rem;color:var(--primary)" id="totalOrders">0</div><div style="color:var(--gray)">总订单数</div></div>
            <div class="card"><div style="font-size:1.6rem;color:var(--primary)" id="processedToday">0</div><div style="color:var(--gray)">今日已处理</div></div>
            <div class="card"><div style="font-size:1.6rem;color:var(--primary)" id="timeSaved">0</div><div style="color:var(--gray)">节省时间(分钟)</div></div>
            <div class="card"><div style="font-size:1.6rem;color:var(--primary)" id="successRate">100%</div><div style="color:var(--gray)">识别成功率</div></div>
        </div>

        <div class="main-content">
            <div class="card">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px"><i class="fas fa-edit" style="font-size:1.2rem;color:var(--primary)"></i><h3>输入收件人信息</h3></div>
                <textarea id="inputText" placeholder="请将收件人信息粘贴，每条用 # 分隔。支持规格（大果、中果、小果）及数量。"></textarea>
                <div style="margin-top:12px"><button id="extractBtn" class="btn btn-primary"><i class="fas fa-cogs"></i> 提取信息</button></div>
            </div>

            <div class="card">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px"><i class="fas fa-table" style="font-size:1.2rem;color:var(--primary)"></i><h3>提取结果</h3></div>
                <div id="loadedMeta" style="color:var(--gray);margin-bottom:8px;"></div>
                <div style="margin-bottom:12px;">
                    <button id="viewSavedBtn" class="btn btn-primary btn-small" style="margin-right:8px"><i class="fas fa-folder-open"></i> 查看本地保存项</button>
                </div>
                <div class="action-buttons">
                    <button id="saveBtn" class="btn btn-primary"><i class="fas fa-save"></i> 保存数据</button>
                    <button id="copyBtn" class="btn btn-primary"><i class="fas fa-copy"></i> 复制表格数据</button>
                    <button id="exportBtn" class="btn btn-primary"><i class="fas fa-file-excel"></i> 导出Excel文件</button>
                </div>
                <div class="table-container" id="tableContainer"><div class="empty-state"><i class="fas fa-inbox"></i><p>提取结果将显示在这里</p></div></div>
            </div>
        </div>

        <!-- 以下部分保持不变 -->
        <div class="github-panel">
    <h3><i class="fab fa-github"></i> GitHub 数据存储</h3>
    <div>
        <div><label>GitHub访问令牌</label><input id="githubToken" type="password" class="form-input" placeholder="PAT (需要 repo 权限)"></div>
        <div><label>仓库 (owner/repo)</label><input id="githubRepo" class="form-input" placeholder="username/repo-name" value="your-username/fresh-fruit-orders"></div>
        <div><label>分支</label><input id="githubBranch" class="form-input" placeholder="main" value="main"></div>
        <div><label>仓库所有者 (owner)</label><input id="githubOwner" class="form-input" placeholder="GitHub用户名"></div>
    </div>
    <!-- 其余代码保持不变 -->

            <!-- 管理员选择某用户某天的数据 -->
            <div class="form-row" style="margin-top:12px;">
                <div style="flex:1">
                    <label>选择用户</label>
                    <select id="githubUserSelect" class="form-input admin-only"></select>
                </div>
                <div style="flex:1">
                    <label>选择日期 / 文件</label>
                    <select id="githubDateSelect" class="form-input admin-only"></select>
                </div>
                <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-start">
                    <button id="listOrderFilesBtn" class="btn btn-primary admin-only" style="white-space:nowrap">刷新文件列表</button>
                    <button id="loadSelectedFileBtn" class="btn btn-primary admin-only" style="white-space:nowrap;margin-top:6px">加载选中文件</button>
                </div>
            </div>
            <div class="small-note">管理员可以先点击"刷新文件列表"获取仓库 orders 目录下的上传记录，然后选择用户和对应日期加载该文件。</div>

            <div>
                <button id="testGithubBtn" class="btn btn-primary"><i class="fas fa-plug"></i> 测试连接</button>
                <button id="saveGithubConfigBtn" class="btn btn-primary"><i class="fas fa-save"></i> 保存配置</button>
                <button id="syncToGithubBtn" class="btn btn-primary"><i class="fas fa-cloud-upload-alt"></i> 同步到GitHub</button>
                <button id="loadFromGithubBtn" class="btn btn-primary"><i class="fas fa-cloud-download-alt"></i> 从GitHub加载最近文件</button>
                <button id="loadAllFromGithubBtn" class="btn btn-primary admin-only"><i class="fas fa-download"></i> 加载所有用户数据</button>
            </div>
        </div>

        <div class="user-management-panel admin-only" id="userManagementPanel">
            <h3><i class="fas fa-users-cog"></i> 用户管理 (管理员可见)</h3>
            <div>
                <div><label>用户名</label><input id="newUsername" class="form-input"></div>
                <div><label>密码</label><input id="newPassword" type="password" class="form-input"></div>
                <div><label>角色</label><select id="userRoleSelect" class="form-input"><option value="user">普通用户</option><option value="admin">管理员</option></select></div>
            </div>
            <div>
                <button id="addUserBtn" class="btn btn-primary"><i class="fas fa-user-plus"></i> 添加用户</button>
                <button id="syncUsersToGithubBtn" class="btn btn-primary"><i class="fas fa-cloud-upload-alt"></i> 同步用户到GitHub</button>
                <button id="loadUsersFromGithubBtn" class="btn btn-primary"><i class="fas fa-cloud-download-alt"></i> 从GitHub加载用户</button>
                <button id="refreshUsersBtn" class="btn btn-primary"><i class="fas fa-sync"></i> 刷新用户列表</button>
            </div>
            <h4 style="margin-top:12px">用户列表</h4>
            <div class="user-list" id="userList"></div>
        </div>

        <div class="footer">舍鲜果电商订单汇总工具 &copy; 2025</div>
    </div>

    <div id="savedDataModal">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <strong>本地保存项</strong>
            <div><button id="closeSavedModal" class="btn btn-small">关闭</button></div>
        </div>
        <div id="savedListContainer"></div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- JavaScript代码保持不变 -->
     <script>
        const AUTHORIZED_USERS = [{ username: "admin", password: "admin123", role: "admin" }, { username: "user1", password: "password1", role: "user" }];
        const STORAGE_KEY = 'fresh_fruit_order_data';
        const GITHUB_CONFIG_KEY = 'github_config';
        const USERS_CONFIG_KEY = 'authorized_users';
        let currentTableData = [];
        let processedCount = 0;
        let githubConfig = {};
        let currentUserRole = 'user';
        let currentUsername = '';

        function showToast(message, type='success') {
            const t = document.getElementById('toast'); if (!t) return;
            t.textContent = message; t.className = `toast ${type}`; t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'), 3000);
        }
        function escapeHtml(str){ if (str===undefined || str===null) return ''; return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

        function utf8ToBase64(str) {
            const enc = new TextEncoder();
            const bytes = enc.encode(str);
            let binary = '';
            const chunk = 0x8000;
            for (let i=0;i<bytes.length;i+=chunk){
                const slice = bytes.subarray(i,i+chunk);
                binary += String.fromCharCode.apply(null, Array.from(slice));
            }
            return btoa(binary);
        }
        function base64ToUtf8(b64) {
            const binary = atob(b64);
            const len = binary.length;
            const bytes = new Uint8Array(len);
            for (let i=0;i<len;i++) bytes[i] = binary.charCodeAt(i);
            const dec = new TextDecoder();
            return dec.decode(bytes);
        }

        function cleanupExpiredData() {
            try {
                const now = Date.now();
                const raw = localStorage.getItem(STORAGE_KEY) || '[]';
                const arr = JSON.parse(raw);
                if (!Array.isArray(arr)) { localStorage.setItem(STORAGE_KEY,'[]'); return []; }
                const filtered = arr.filter(item => !item.expiry || item.expiry > now);
                if (filtered.length !== arr.length) localStorage.setItem(STORAGE_KEY, JSON.stringify(filtered));
                return filtered;
            } catch (e) { localStorage.setItem(STORAGE_KEY,'[]'); return []; }
        }

        function cleanAddress(address) {
            if (!address) return '';
            address = String(address);
            // 移除数量（带单位）与规格词，去掉中英文标点及多余空格
            address = address.replace(/(\d+)\s*(盒|个|件|箱)/g, '');
            address = address.replace(/\b(大果|中果|小果)\b/g, '');
            address = address.replace(/（大果|（中果|（小果|大果）|中果）|小果）/g, '');
            address = address.replace(/[，,、~]+/g, ' ').replace(/\s+/g,' ').trim();
            // 移除末尾孤立的规格词（如 " 大果"）
            address = address.replace(/\s*(大果|中果|小果)\s*$/,'').trim();
            return address;
        }

        function updateStats(){
            const totalOrdersEl = document.getElementById('totalOrders');
            const processedTodayEl = document.getElementById('processedToday');
            const timeSavedEl = document.getElementById('timeSaved');
            const successRateEl = document.getElementById('successRate');
            if (totalOrdersEl) totalOrdersEl.textContent = processedCount;
            if (processedTodayEl) processedTodayEl.textContent = currentTableData.length;
            if (timeSavedEl) timeSavedEl.textContent = Math.round(currentTableData.length * 2.5);
            if (successRateEl) successRateEl.textContent = currentTableData.length > 0 ? '100%' : '0%';
        }

        // 提取信息：确保规格词从地址中移除，不重复显示
        function extractInfo(recipient) {
            let raw = recipient || '';
            const lines = raw.split('\n').map(l=>l.trim()).filter(Boolean);
            let text = raw.replace(/\r/g,'').replace(/\n/g,' ').replace(/\s+/g,' ').trim();
            let extension = '';
            const extensionMatch = text.match(/\[(\d+)\]/);
            if (extensionMatch) { extension = `[${extensionMatch[1]}]`; text = text.replace(/\[\d+\]/,'').trim(); }

            // 先尝试匹配规格并从 text 中移除
            const specMatch = text.match(/(大果|中果|小果)/);
            let specification = '';
            if (specMatch) {
                specification = specMatch[1];
                text = text.replace(specMatch[0],'').trim();
            }

            let phoneMatch = text.match(/(\d{7,11})(-\d+)?/);
            if (phoneMatch) {
                const phone = phoneMatch[1];
                let extFromPhone = phoneMatch[2] ? phoneMatch[2].replace(/^-/, '') : '';
                if (extFromPhone && !extension) extension = `[${extFromPhone}]`;
                const idx = text.indexOf(phoneMatch[0]);
                let before = text.substring(0, idx).trim();
                let after = text.substring(idx + phoneMatch[0].length).trim();
                let name = before.replace(/[,，、]/g,'').trim();
                if (extension) name = name + extension;
                // 清理地址，确保规格被移除
                let address = after.replace(/[,，、]/g,' ').trim();
                address = cleanAddress(address);
                let quantity = '';
                const qMatch = raw.match(/(\d+)\s*(盒|个|件|箱)/) || text.match(/(\d+)\s*(盒|个|件|箱)/);
                if (qMatch) { quantity = qMatch[1]; address = cleanAddress(address); }
                return { specification, quantity, slash1:'', slash2:'', name, phone, address, remark:'' };
            }

            if (lines.length >= 2) {
                let nameLine = lines[0] || '';
                let phoneLine = lines.find(l=>/\d{7,11}/.test(l)) || lines[1] || '';
                let addressLine = lines.find(l=>!/\d{7,11}/.test(l) && l !== nameLine) || '';
                const nm = nameLine.match(/^(.+?)(?:\[(\d+)\])?$/);
                if (nm) { nameLine = nm[1].trim(); if (nm[2] && !extension) extension = `[${nm[2]}]`; }
                const pm = (phoneLine||'').match(/(\d{7,11})(?:-*\[(\d+)\])?/);
                if (pm) { phoneLine = pm[1]; if (pm[2] && !extension) extension = `[${pm[2]}]`; }
                else { const anyPhone = text.match(/\d{7,11}/); if (anyPhone) phoneLine = anyPhone[0]; }
                const am = (addressLine||'').match(/^(.+?)(?:\[(\d+)\])?$/);
                if (am) { addressLine = am[1].trim(); if (am[2] && !extension) extension = `[${am[2]}]`; }
                let quantity = '';
                const ql = lines.find(l=>/(\d+)\s*(盒|个|件|箱)/.test(l));
                if (ql) { const qm = ql.match(/(\d+)\s*(盒|个|件|箱)/); if (qm) { quantity = qm[1]; addressLine = cleanAddress(addressLine); } }
                else { const qm2 = addressLine.match(/(\d+)\s*(盒|个|件|箱)/); if (qm2) { quantity = qm2[1]; addressLine = cleanAddress(addressLine); } }
                if (!specification) { const sm = addressLine.match(/(大果|中果|小果)/); if (sm) { specification = sm[1]; addressLine = addressLine.replace(sm[0],'').trim(); } }
                addressLine = cleanAddress(addressLine);
                const fullName = (nameLine + (extension || '')).trim();
                return { specification, quantity, slash1:'', slash2:'', name: fullName, phone: phoneLine || '', address: addressLine || '', remark: '' };
            }

            return { specification:'', quantity:'', slash1:'', slash2:'', name:text||raw, phone:'', address:'', remark:'解析失败' };
        }

        function generateTable(data) {
            const tableContainer = document.getElementById('tableContainer');
            if (!tableContainer) return;
            if (!Array.isArray(data) || data.length === 0) {
                tableContainer.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>未提取到有效信息</p></div>';
                return;
            }
            let html = '<table><thead><tr><th>规格</th><th>数量</th><th>/</th><th>/</th><th>姓名</th><th>电话</th><th>地址</th><th>备注</th></tr></thead><tbody>';
            data.forEach(item=>{
                // 确保 address 里没有规格词
                const addr = cleanAddress(item.address || '');
                const spec = item.specification || '';
                html += `<tr>
                    <td>${escapeHtml(spec)}</td>
                    <td>${escapeHtml(item.quantity)}</td>
                    <td>${escapeHtml(item.slash1)}</td>
                    <td>${escapeHtml(item.slash2)}</td>
                    <td>${escapeHtml(item.name)}</td>
                    <td>${escapeHtml(item.phone)}</td>
                    <td>${escapeHtml(addr)}</td>
                    <td>${escapeHtml(item.remark)}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            tableContainer.innerHTML = html;
        }

        function exportToExcel(data, filename){
            if (typeof XLSX === 'undefined') { showToast('未找到 XLSX 库，无法导出','error'); return; }
            const wb = XLSX.utils.book_new();
            const wsData = [['规格','数量','/','/','姓名','电话','地址','备注']];
            data.forEach(item => wsData.push([item.specification||'', item.quantity||'', item.slash1||'', item.slash2||'', item.name||'', item.phone||'', cleanAddress(item.address||''), item.remark||'']));
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, '订单信息');
            XLSX.writeFile(wb, (filename||'orders') + '.xlsx');
        }

        function loadGithubConfig(){
            const cfg = localStorage.getItem(GITHUB_CONFIG_KEY);
            try{ githubConfig = cfg ? JSON.parse(cfg) : {}; } catch(e){ githubConfig = {}; }
            const tokenEl = document.getElementById('githubToken');
            const repoEl = document.getElementById('githubRepo');
            const branchEl = document.getElementById('githubBranch');
            const ownerEl = document.getElementById('githubOwner');
            if (tokenEl) tokenEl.value = githubConfig.token || '';
            if (repoEl) repoEl.value = (githubConfig.owner && githubConfig.repo) ? `${githubConfig.owner}/${githubConfig.repo}` : (githubConfig.repo || 'your-username/fresh-fruit-orders');
            if (branchEl) branchEl.value = githubConfig.branch || 'main';
            if (ownerEl) ownerEl.value = githubConfig.owner || '';
        }
        function saveGithubConfig(){
            const token = (document.getElementById('githubToken')||{}).value.trim();
            let repoVal = (document.getElementById('githubRepo')||{}).value.trim();
            const branch = (document.getElementById('githubBranch')||{}).value.trim() || 'main';
            let owner = (document.getElementById('githubOwner')||{}).value.trim();
            if (repoVal && repoVal.includes('/')) { const parts = repoVal.split('/'); owner = parts[0]; repoVal = parts[1]; }
            githubConfig = { token, repo: repoVal, branch, owner };
            localStorage.setItem(GITHUB_CONFIG_KEY, JSON.stringify(githubConfig));
            showToast('GitHub配置已保存');
        }

        async function githubApiRequest(url, method='GET', body=null){
            const headers = { 'Accept': 'application/vnd.github.v3+json' };
            if (githubConfig && githubConfig.token) headers['Authorization'] = `token ${githubConfig.token}`;
            const options = { method, headers };
            if (body) { options.body = JSON.stringify(body); headers['Content-Type'] = 'application/json'; }
            const resp = await fetch(url, options);
            const text = await resp.text();
            let data;
            try { data = text ? JSON.parse(text) : {}; } catch(e) { data = { raw: text }; }
            if (!resp.ok) { const msg = data && data.message ? data.message : `HTTP ${resp.status}`; throw new Error(msg); }
            return data;
        }

        async function testGithubConnection(){
            loadGithubConfig();
            if (!githubConfig.token) { showToast('请先填写并保存GitHub令牌','error'); return false; }
            try { const user = await githubApiRequest('https://api.github.com/user'); showToast(`连接成功：${user.login || '已认证'}`); return true; }
            catch(err){ showToast('连接失败：' + (err.message||err),'error'); return false; }
        }

        async function syncToGithub(){
            if (!Array.isArray(currentTableData) || currentTableData.length === 0) { showToast('没有要同步的数据','error'); return; }
            loadGithubConfig();
            if (!githubConfig || !githubConfig.repo || !githubConfig.owner) { showToast('请先填写并保存仓库信息（owner 和 repo）','error'); return; }
            const user = currentUsername || localStorage.getItem('loggedInUser') || 'unknown';
            const now = Date.now();
            const formatted = new Date(now).toISOString().replace(/[:.]/g,'-');
            const filename = `orders/${user}_${formatted}.json`;
            const payload = { user, timestamp: now, data: currentTableData };
            const contentBase64 = utf8ToBase64(JSON.stringify(payload, null, 2));
            const fileUrl = `https://api.github.com/repos/${encodeURIComponent(githubConfig.owner)}/${encodeURIComponent(githubConfig.repo)}/contents/${encodeURIComponent(filename)}`;
            try {
                let sha = null;
                try {
                    const existing = await githubApiRequest(`${fileUrl}?ref=${githubConfig.branch}`);
                    if (existing && existing.sha) sha = existing.sha;
                } catch(e){}
                const body = { message: `Add orders ${user} ${formatted}`, content: contentBase64, branch: githubConfig.branch || 'main' };
                if (sha) body.sha = sha;
                await githubApiRequest(fileUrl, 'PUT', body);
                showToast('同步到GitHub成功');
            } catch (err) { showToast('同步失败：' + (err.message||err),'error'); throw err; }
        }

        function extractTimestampFromName(name) {
            if (!name) return 0;
            const m = name.match(/(\d{4}-\d{2}-\d{2}T\d{2}-\d{2}-\d{2})/);
            if (m) { try { return Date.parse(m[1].replace(/-/g, (s,i)=> i===4||i===7?'-':':')); } catch(e){} }
            const mNum = name.match(/(\d{13,})/);
            if (mNum) return parseInt(mNum[1],10);
            const mDate = name.match(/(\d{8}_\d{6})/);
            if (mDate) {
                const s = mDate[1];
                const y=s.slice(0,4),mo=s.slice(4,6),d=s.slice(6,8),h=s.slice(9,11),mi=s.slice(11,13),se=s.slice(13,15);
                const t = Date.parse(`${y}-${mo}-${d}T${h}:${mi}:${se}`);
                return isNaN(t)?0:t;
            }
            return 0;
        }
        function extractUserFromName(name){ if (!name) return ''; const m = name.match(/^([^_]+)_/); return m?m[1]:''; }
        function fNameIncludesUser(name,user){ if (!name||!user) return false; return name.indexOf(user)!==-1; }

        async function listOrderFiles() {
            loadGithubConfig();
            if (!githubConfig || !githubConfig.repo || !githubConfig.owner) { showToast('请先填写并保存仓库信息（owner 和 repo）','error'); return; }
            try {
                const listUrl = `https://api.github.com/repos/${encodeURIComponent(githubConfig.owner)}/${encodeURIComponent(githubConfig.repo)}/contents/orders?ref=${githubConfig.branch || 'main'}`;
                const files = await githubApiRequest(listUrl);
                if (!Array.isArray(files) || files.length === 0) { showToast('GitHub上 orders 目录为空或未找到','error'); return; }
                // 构建 user -> files map
                const map = {};
                for (const f of files) {
                    try {
                        const user = extractUserFromName(f.name) || 'unknown';
                        const ts = extractTimestampFromName(f.name) || 0;
                        const dateLabel = ts ? new Date(ts).toLocaleString() : f.name;
                        if (!map[user]) map[user] = [];
                        map[user].push({ name: f.name, file: f, ts, label: `${dateLabel} — ${f.name}` });
                    } catch(e){
                        console.error('解析文件失败', f.name, e);
                    }
                }
                // 填充用户 select
                const userSelect = document.getElementById('githubUserSelect');
                const dateSelect = document.getElementById('githubDateSelect');
                if (!userSelect || !dateSelect) return;
                const users = Object.keys(map).sort();
                userSelect.innerHTML = '<option value="">请选择用户</option>' + users.map(u => `<option value="${escapeHtml(u)}">${escapeHtml(u)}</option>`).join('');
                dateSelect.innerHTML = '<option value="">请选择日期/文件</option>';
                // 缓存在元素上
                userSelect.__filesMap = map;
                showToast(`已获取 ${files.length} 个文件，${users.length} 位上传用户`);
            } catch(err){ showToast('获取文件列表失败：' + (err.message||err),'error'); }
        }

        function populateDateSelectForUser(user) {
            const userSelect = document.getElementById('githubUserSelect');
            const dateSelect = document.getElementById('githubDateSelect');
            if (!userSelect || !dateSelect) return;
            const map = userSelect.__filesMap || {};
            const list = map[user] || [];
            if (!list || list.length === 0) {
                dateSelect.innerHTML = '<option value="">无可用文件</option>';
                return;
            }
            const sorted = list.slice().sort((a,b) => (b.ts || 0) - (a.ts || 0));
            dateSelect.innerHTML = '<option value="">请选择日期/文件</option>' + sorted.map(it => `<option value="${escapeHtml(it.name)}" data-ts="${it.ts || 0}">${escapeHtml(it.label)}</option>`).join('');
        }

        async function loadSelectedFile() {
            const userSelect = document.getElementById('githubUserSelect');
            const dateSelect = document.getElementById('githubDateSelect');
            loadGithubConfig();
            if (!githubConfig || !githubConfig.repo || !githubConfig.owner) { showToast('请先填写并保存仓库信息（owner 和 repo）','error'); return; }
            if (!userSelect || !dateSelect) return;
            const fileName = dateSelect.value;
            if (!fileName) { showToast('请先选择文件','error'); return; }
            try {
                const fileUrl = `https://api.github.com/repos/${encodeURIComponent(githubConfig.owner)}/${encodeURIComponent(githubConfig.repo)}/contents/${encodeURIComponent('orders/' + fileName)}?ref=${githubConfig.branch || 'main'}`;
                const contentApi = await githubApiRequest(fileUrl);
                if (!contentApi || !contentApi.content) throw new Error('未获取到文件内容');
                const decoded = base64ToUtf8(contentApi.content.replace(/\n/g,''));
                const fileJson = JSON.parse(decoded);
                let parsedData = [];
                if (Array.isArray(fileJson)) parsedData = fileJson;
                else if (fileJson && fileJson.data) parsedData = fileJson.data;
                currentTableData = Array.isArray(parsedData) ? parsedData : [];
                generateTable(currentTableData);
                const metaEl = document.getElementById('loadedMeta');
                const ts = extractTimestampFromName(fileName) || Number(dateSelect.selectedOptions[0].dataset.ts) || 0;
                const uploader = extractUserFromName(fileName) || '未知';
                if (metaEl) metaEl.textContent = `已加载：${fileName} （上传者：${uploader}，时间：${ts ? new Date(ts).toLocaleString() : '未知'}）`;
                showToast(`已加载 ${currentTableData.length} 条数据`);
            } catch(err){ showToast('加载失败：' + (err.message||err),'error'); }
        }

        async function loadFromGithub(){
            loadGithubConfig();
            if (!githubConfig || !githubConfig.repo || !githubConfig.owner) { showToast('请先填写并保存仓库信息（owner 和 repo）','error'); return; }
            try {
                const currentUser = currentUsername || localStorage.getItem('loggedInUser') || '';
                const isAdmin = currentUserRole === 'admin';
                const listUrl = `https://api.github.com/repos/${encodeURIComponent(githubConfig.owner)}/${encodeURIComponent(githubConfig.repo)}/contents/orders?ref=${githubConfig.branch || 'main'}`;
                const files = await githubApiRequest(listUrl);
                if (!Array.isArray(files) || files.length === 0) { showToast('GitHub上没有找到订单数据','error'); return; }

                const candidates = [];
                for (const f of files) {
                    try {
                        const contentApi = await githubApiRequest(`https://api.github.com/repos/${encodeURIComponent(githubConfig.owner)}/${encodeURIComponent(githubConfig.repo)}/contents/${encodeURIComponent('orders/' + f.name)}?ref=${githubConfig.branch || 'main'}`);
                        if (contentApi && contentApi.content) {
                            const decoded = base64ToUtf8(contentApi.content.replace(/\n/g,''));
                            const fileJson = JSON.parse(decoded);
                            if (fileJson && fileJson.data) candidates.push({ file: f, parsed: { data: fileJson.data, timestamp: fileJson.timestamp || extractTimestampFromName(f.name), user: fileJson.user || extractUserFromName(f.name) } });
                            else if (Array.isArray(fileJson)) candidates.push({ file: f, parsed: { data: fileJson, timestamp: extractTimestampFromName(f.name), user: extractUserFromName(f.name) } });
                        } else if (f.download_url) {
                            const r = await fetch(f.download_url);
                            if (r.ok) {
                                try {
                                    const fileJson = await r.json();
                                    if (fileJson && fileJson.data) candidates.push({ file: f, parsed: { data: fileJson.data, timestamp: fileJson.timestamp || extractTimestampFromName(f.name), user: fileJson.user || extractUserFromName(f.name) } });
                                    else if (Array.isArray(fileJson)) candidates.push({ file: f, parsed: { data: fileJson, timestamp: extractTimestampFromName(f.name), user: extractUserFromName(f.name) } });
                                } catch(e){}
                            }
                        }
                    } catch(e){
                        console.error('读取文件失败', f.name, e);
                    }
                }

                const filtered = isAdmin ? candidates : candidates.filter(c => fNameIncludesUser(c.file.name, currentUser));
                if (!filtered || filtered.length === 0) { showToast('未找到当前用户的上传记录','error'); return; }
                const sorted = filtered.sort((a,b)=> (b.parsed.timestamp||0) - (a.parsed.timestamp||0));
                const latest = sorted[0];
                currentTableData = Array.isArray(latest.parsed.data) ? latest.parsed.data : [];
                generateTable(currentTableData);
                const metaEl = document.getElementById('loadedMeta');
                if (metaEl) metaEl.textContent = `已加载：${latest.file.name} （上传者：${latest.parsed.user || '未知'}，时间：${new Date(latest.parsed.timestamp||0).toLocaleString() || '未知'}）`;
                showToast(`从GitHub加载了 ${currentTableData.length} 条订单数据`);
            } catch(err){ showToast('从GitHub加载数据失败: ' + (err.message||err),'error'); }
        }

        async function loadAllFromGithub(){
            loadGithubConfig();
            if (!githubConfig || !githubConfig.repo || !githubConfig.owner) { showToast('请先填写并保存仓库信息（owner 和 repo）','error'); return; }
            if (currentUserRole !== 'admin') { showToast('只有管理员可以执行此操作','error'); return; }
            try {
                const listUrl = `https://api.github.com/repos/${encodeURIComponent(githubConfig.owner)}/${encodeURIComponent(githubConfig.repo)}/contents/orders?ref=${githubConfig.branch || 'main'}`;
                const files = await githubApiRequest(listUrl);
                if (!Array.isArray(files) || files.length === 0) { showToast('GitHub上没有找到订单数据','error'); return; }
                let all = [];
                for (const f of files) {
                    try {
                        const contentApi = await githubApiRequest(`https://api.github.com/repos/${encodeURIComponent(githubConfig.owner)}/${encodeURIComponent(githubConfig.repo)}/contents/${encodeURIComponent('orders/' + f.name)}?ref=${githubConfig.branch || 'main'}`);
                        if (contentApi && contentApi.content) {
                            const decoded = base64ToUtf8(contentApi.content.replace(/\n/g,''));
                            const fileJson = JSON.parse(decoded);
                            if (Array.isArray(fileJson)) all = all.concat(fileJson);
                            else if (fileJson && fileJson.data) all = all.concat(fileJson.data);
                        } else if (f.download_url) {
                            const r = await fetch(f.download_url);
                            if (r.ok) {
                                try { const json = await r.json(); if (Array.isArray(json)) all = all.concat(json); else if (json && json.data) all = all.concat(json.data); } catch(e){}
                            }
                        }
                    } catch(e){ console.error('加载文件失败', f.name, e); }
                }
                currentTableData = all;
                generateTable(currentTableData);
                showToast(`从GitHub加载了所有用户数据，共 ${currentTableData.length} 条订单`);
            } catch(err){ showToast('从GitHub加载所有数据失败: ' + (err.message||err),'error'); }
        }

        // 用户同步
        async function syncUsersToGithub(){
            loadGithubConfig();
            if (!githubConfig || !githubConfig.repo || !githubConfig.owner) { showToast('请先填写并保存仓库信息（owner 和 repo）','error'); return; }
            if (currentUserRole !== 'admin') { showToast('只有管理员可以执行此操作','error'); return; }
            try {
                const users = loadUsers();
                const filename = `users.json`;
                const fileUrl = `https://api.github.com/repos/${encodeURIComponent(githubConfig.owner)}/${encodeURIComponent(githubConfig.repo)}/contents/${filename}`;
                let sha = null;
                try { const existing = await githubApiRequest(`${fileUrl}?ref=${githubConfig.branch}`); if (existing && existing.sha) sha = existing.sha; } catch(e){}
                const jsonStr = JSON.stringify(users, null, 2);
                const content = utf8ToBase64(jsonStr);
                const body = { message: `同步用户数据 - ${new Date().toLocaleString()}`, content, branch: githubConfig.branch || 'main' };
                if (sha) body.sha = sha;
                await githubApiRequest(fileUrl, 'PUT', body);
                showToast('用户数据已成功同步到GitHub');
            } catch(err){ showToast('同步用户数据失败: ' + (err.message||err),'error'); throw err; }
        }

        async function loadUsersFromGithub(){
            loadGithubConfig();
            if (!githubConfig || !githubConfig.repo || !githubConfig.owner) { showToast('请先填写并保存仓库信息（owner 和 repo）','error'); return; }
            if (currentUserRole !== 'admin') { showToast('只有管理员可以执行此操作','error'); return; }
            try {
                const filename = `users.json`;
                const fileUrl = `https://api.github.com/repos/${encodeURIComponent(githubConfig.owner)}/${encodeURIComponent(githubConfig.repo)}/contents/${filename}?ref=${githubConfig.branch || 'main'}`;
                const fileContent = await githubApiRequest(fileUrl);
                if (!fileContent || !fileContent.content) throw new Error('未获取到用户文件内容');
                const decoded = base64ToUtf8(fileContent.content.replace(/\n/g,''));
                const users = JSON.parse(decoded);
                saveUsers(users);
                renderUserList();
                showToast('用户数据已从GitHub加载并更新本地存储');
                return users;
            } catch(err){ showToast('从GitHub加载用户数据失败: ' + (err.message||err),'error'); throw err; }
        }

        // 本地用户管理
        function loadUsers(){ const s = localStorage.getItem(USERS_CONFIG_KEY); if (s) { try { return JSON.parse(s); } catch(e) {} } localStorage.setItem(USERS_CONFIG_KEY, JSON.stringify(AUTHORIZED_USERS)); return AUTHORIZED_USERS.slice(); }
        function saveUsers(users){ localStorage.setItem(USERS_CONFIG_KEY, JSON.stringify(users)); }
        function addUser(username,password,role){ const users = loadUsers(); if (users.some(u=>u.username===username)) return { success:false, message:'用户名已存在' }; users.push({ username, password, role }); saveUsers(users); return { success:true, message:'用户添加成功' }; }
        function deleteUser(username){ const users = loadUsers(); const currentUser = localStorage.getItem('loggedInUser'); if (username === currentUser) return { success:false, message:'不能删除当前登录用户' }; const adminUsers = users.filter(u=>u.role==='admin'); if (adminUsers.length === 1 && adminUsers[0].username === username) return { success:false, message:'必须至少保留一个管理员账户' }; const filtered = users.filter(u=>u.username!==username); saveUsers(filtered); return { success:true, message:'用户删除成功' }; }

        function renderUserList(){
            const userList = document.getElementById('userList');
            const users = loadUsers();
            if (!userList) return;
            if (!users || users.length===0){ userList.innerHTML = '<div style="justify-content:center;color:var(--gray);display:flex;padding:12px">暂无用户</div>'; return; }
            let html = '';
            users.forEach(user=>{
                html += `<div class="user-item"><div style="display:flex;gap:10px;align-items:center"><div class="user-avatar" style="width:24px;height:24px;font-size:0.75rem">${escapeHtml(user.username.charAt(0).toUpperCase())}</div><div>${escapeHtml(user.username)}</div><div style="margin-left:8px;padding:2px 8px;border-radius:8px;background:${user.role==='admin'?'var(--primary)':'var(--gray)'};color:#fff;font-size:0.75rem">${user.role==='admin'?'管理员':'普通用户'}</div></div><div><button class="btn btn-small btn-danger delete-user-btn" data-username="${escapeHtml(user.username)}"><i class="fas fa-trash"></i> 删除</button></div></div>`;
            });
            userList.innerHTML = html;
            document.querySelectorAll('.delete-user-btn').forEach(btn=>btn.addEventListener('click',function(){
                const username = this.getAttribute('data-username');
                const res = deleteUser(username);
                if (res.success){ showToast(res.message); renderUserList(); } else showToast(res.message,'error');
            }));
        }

        function updateUserInterface(){
            const isAdmin = currentUserRole === 'admin';
            document.querySelectorAll('.admin-only').forEach(el=> el.style.display = isAdmin ? 'block' : 'none');
            if (isAdmin) renderUserList();
        }

        function listSavedData(){
            const list = cleanupExpiredData();
            const container = document.getElementById('savedListContainer');
            if (!container) return;
            if (!list || list.length===0){ container.innerHTML = '<div style="color:var(--gray)">没有本地保存项</div>'; return; }
            let html = '<div style="display:flex;flex-direction:column;gap:8px">';
            list.slice().reverse().forEach(item=>{
                const time = new Date(item.timestamp).toLocaleString();
                html += `<div style="border:1px solid #eee;padding:10px;border-radius:6px;display:flex;justify-content:space-between;align-items:center">
                    <div style="max-width:70%;word-break:break-all"><div><strong>用户：</strong>${escapeHtml(item.username||'')} <small style="color:var(--gray)">(${time})</small></div><div style="color:var(--gray);margin-top:6px">条数：${(item.data||[]).length}</div></div>
                    <div style="display:flex;gap:8px"><button class="btn btn-small" data-id="${item.id}" onclick="window.__loadSaved('${item.id}')">加载</button><button class="btn btn-small btn-danger" data-id="${item.id}" onclick="window.__deleteSaved('${item.id}')">删除</button></div>
                </div>`;
            });
            html += '</div>';
            container.innerHTML = html;
            window.__loadSaved = function(id){ loadSavedItem(id); };
            window.__deleteSaved = function(id){ deleteSavedItem(id); };
        }

        function openSavedModal(){ listSavedData(); document.getElementById('savedDataModal').style.display = 'block'; }
        function closeSavedModal(){ document.getElementById('savedDataModal').style.display = 'none'; }

        function loadSavedItem(id){
            const arr = cleanupExpiredData();
            const item = arr.find(i => String(i.id) === String(id));
            if (!item){ showToast('未找到保存项或已过期','error'); return; }
            currentTableData = Array.isArray(item.data) ? item.data : [];
            generateTable(currentTableData);
            updateStats();
            showToast('已加载本地保存项');
            closeSavedModal();
        }

        function deleteSavedItem(id){
            let arr = cleanupExpiredData();
            const before = arr.length;
            arr = arr.filter(i => String(i.id) !== String(id));
            if (arr.length === before){ showToast('未找到要删除的项','error'); return; }
            localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
            listSavedData();
            showToast('已删除保存项');
        }

        (function bindEvents(){
            document.getElementById('loginForm').addEventListener('submit', function(e){
                e.preventDefault();
                const username = (document.getElementById('username')||{}).value.trim();
                const password = (document.getElementById('password')||{}).value.trim();
                const err = document.getElementById('loginError');
                const users = loadUsers();
                const user = users.find(u=>u.username===username && u.password===password);
                if (user){
                    localStorage.setItem('loggedInUser', username);
                    localStorage.setItem('userRole', user.role);
                    currentUserRole = user.role; currentUsername = username;
                    if (err) err.style.display = 'none';
                    document.getElementById('loginContainer').classList.add('hidden');
                    document.getElementById('appContainer').classList.remove('hidden');
                    document.getElementById('userName').textContent = username;
                    document.getElementById('userAvatar').innerHTML = escapeHtml(username.charAt(0).toUpperCase());
                    document.getElementById('userRole').textContent = user.role === 'admin' ? '管理员' : '普通用户';
                    updateUserInterface(); loadGithubConfig(); showToast(`欢迎回来，${username}！`);
                } else {
                    if (err) err.style.display = 'block';
                    (document.getElementById('password')||{}).value = '';
                }
            });

            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) logoutBtn.addEventListener('click', function(){
                localStorage.removeItem('loggedInUser');
                localStorage.removeItem('userRole');
                currentUserRole = 'user'; currentUsername = '';
                document.getElementById('loginContainer').classList.remove('hidden');
                document.getElementById('appContainer').classList.add('hidden');
                (document.getElementById('username')||{}).value = '';
                (document.getElementById('password')||{}).value = '';
                const loginError = document.getElementById('loginError'); if (loginError) loginError.style.display = 'none';
            });

            const extractBtn = document.getElementById('extractBtn');
            if (extractBtn) extractBtn.addEventListener('click', function(){
                const input = (document.getElementById('inputText')||{}).value || '';
                if (!input.trim()){ showToast('请输入收件人信息','error'); return; }
                const recipients = input.split('#').map(r=>r.trim()).filter(Boolean);
                currentTableData = recipients.map(r => extractInfo(r));
                generateTable(currentTableData);
                processedCount += currentTableData.length;
                updateStats();
                if (currentTableData.length > 0) showToast(`成功提取 ${currentTableData.length} 条订单信息`);
                else showToast('未提取到有效信息，请检查输入格式','error');
            });

            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) saveBtn.addEventListener('click', function(){
                if (!currentTableData.length){ showToast('没有数据可保存','error'); return; }
                const all = cleanupExpiredData();
                const ts = Date.now();
                const expiry = ts + 30 * 24 * 60 * 60 * 1000;
                const user = currentUsername || localStorage.getItem('loggedInUser') || 'unknown';
                const newData = { id: ts, username: user, data: currentTableData, timestamp: ts, expiry };
                all.push(newData);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(all));
                showToast(`数据已保存（${currentTableData.length} 条），将保留 30 天`);
            });

            const copyBtn = document.getElementById('copyBtn');
            if (copyBtn) copyBtn.addEventListener('click', function(){
                if (!currentTableData.length){ showToast('没有表格数据可复制','error'); return; }
                let csv = '规格,数量,/,/,姓名,电话,地址,备注\n';
                currentTableData.forEach(i => csv += `${i.specification||''},${i.quantity||''},${i.slash1||''},${i.slash2||''},${i.name||''},${i.phone||''},${cleanAddress(i.address||'')||''},${i.remark||''}\n`);
                navigator.clipboard.writeText(csv).then(()=>showToast('表格数据已复制到剪贴板')).catch(()=>{
                    const ta=document.createElement('textarea'); ta.value=csv; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showToast('表格数据已复制到剪贴板');
                });
            });

            const exportBtn = document.getElementById('exportBtn');
            if (exportBtn) exportBtn.addEventListener('click', function(){ if (!currentTableData.length){ showToast('没有表格数据可导出','error'); return; } const d=new Date(); const filename=`舍鲜果订单信息_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`; exportToExcel(currentTableData, filename); showToast('Excel文件已生成并开始下载'); });

            const testGithubBtn = document.getElementById('testGithubBtn'); if (testGithubBtn) testGithubBtn.addEventListener('click', testGithubConnection);
            const saveGithubConfigBtn = document.getElementById('saveGithubConfigBtn'); if (saveGithubConfigBtn) saveGithubConfigBtn.addEventListener('click', saveGithubConfig);
            const syncToGithubBtn = document.getElementById('syncToGithubBtn'); if (syncToGithubBtn) syncToGithubBtn.addEventListener('click', syncToGithub);
            const loadFromGithubBtn = document.getElementById('loadFromGithubBtn'); if (loadFromGithubBtn) loadFromGithubBtn.addEventListener('click', loadFromGithub);
            const loadAllFromGithubBtn = document.getElementById('loadAllFromGithubBtn'); if (loadAllFromGithubBtn) loadAllFromGithubBtn.addEventListener('click', loadAllFromGithub);

            const listOrderFilesBtn = document.getElementById('listOrderFilesBtn'); if (listOrderFilesBtn) listOrderFilesBtn.addEventListener('click', listOrderFiles);
            const githubUserSelect = document.getElementById('githubUserSelect'); if (githubUserSelect) githubUserSelect.addEventListener('change', function(){ populateDateSelectForUser(this.value); });
            const loadSelectedFileBtn = document.getElementById('loadSelectedFileBtn'); if (loadSelectedFileBtn) loadSelectedFileBtn.addEventListener('click', loadSelectedFile);

            const addUserBtn = document.getElementById('addUserBtn'); if (addUserBtn) addUserBtn.addEventListener('click', function(){
                const username = (document.getElementById('newUsername')||{}).value.trim();
                const password = (document.getElementById('newPassword')||{}).value.trim();
                const role = (document.getElementById('userRoleSelect')||{}).value || 'user';
                if (!username || !password){ showToast('请输入用户名和密码','error'); return; }
                const res = addUser(username,password,role);
                if (res.success){ showToast(res.message); (document.getElementById('newUsername')||{}).value=''; (document.getElementById('newPassword')||{}).value=''; renderUserList(); }
                else showToast(res.message,'error');
            });

            const syncUsersToGithubBtn = document.getElementById('syncUsersToGithubBtn'); if (syncUsersToGithubBtn) syncUsersToGithubBtn.addEventListener('click', syncUsersToGithub);
            const loadUsersFromGithubBtn = document.getElementById('loadUsersFromGithubBtn'); if (loadUsersFromGithubBtn) loadUsersFromGithubBtn.addEventListener('click', loadUsersFromGithub);
            const refreshUsersBtn = document.getElementById('refreshUsersBtn'); if (refreshUsersBtn) refreshUsersBtn.addEventListener('click', function(){ renderUserList(); showToast('用户列表已刷新'); });

            const viewSavedBtn = document.getElementById('viewSavedBtn'); if (viewSavedBtn) viewSavedBtn.addEventListener('click', openSavedModal);
            const closeSavedModalBtn = document.getElementById('closeSavedModal'); if (closeSavedModalBtn) closeSavedModalBtn.addEventListener('click', closeSavedModal);

            window.addEventListener('load', function(){
                cleanupExpiredData();
                const loggedInUser = localStorage.getItem('loggedInUser');
                const userRole = localStorage.getItem('userRole');
                if (loggedInUser){
                    currentUsername = loggedInUser;
                    currentUserRole = userRole || 'user';
                    document.getElementById('loginContainer').classList.add('hidden');
                    document.getElementById('appContainer').classList.remove('hidden');
                    document.getElementById('userName').textContent = loggedInUser;
                    document.getElementById('userAvatar').innerHTML = escapeHtml(loggedInUser.charAt(0).toUpperCase());
                    document.getElementById('userRole').textContent = currentUserRole === 'admin' ? '管理员' : '普通用户';
                    updateUserInterface(); loadGithubConfig();
                }
                updateStats();
            }, { once:true });
        })();
    </script>
</body>
</html>
